<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Tin Tức</title>
    <link rel="stylesheet" href="css/search.css" />
    <link rel="stylesheet" href="css/all.min.css" />
    <link rel="stylesheet" href="css/bootstrap.css" />
    <link rel="stylesheet" href="css/style.css" />
    <link rel="stylesheet" href="css/owl.carousel.css" />
    <link rel="stylesheet" href="css/owl.theme.default.css" />
    <link rel="icon" href="images/favicon.png" type="image/x-icon" />
    <script src="js/bootstrap.bundle.min.js"></script>
    <style>
        .news-section {
            padding: 50px 0;
        }
        .news-container {
            background-color: #F5F5F5;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
        }
        .news-item {
            display: flex;
            margin-bottom: 20px;
            padding-bottom: 20px;
            border-bottom: 1px solid #C5A880;
        }
        .news-item img {
            width: 40%;
            height: 200px;
            object-fit: cover;
            border-radius: 5px;
        }
        .news-item .content {
            width: 60%;
            padding-left: 20px;
        }
        .news-item h3 {
            font-size: 24px;
            color: #333333;
            margin-bottom: 10px;
        }
        .news-item p {
            font-size: 16px;
            color: #666666;
        }
        .news-item a {
            color: #77A8A8;
            text-decoration: none;
        }
        .news-item a:hover {
            text-decoration: underline;
        }
        .news-id {
            font-size: 14px;
            color: #666666;
            margin-bottom: 5px;
        }
        .banner-right {
            margin-top: 20px;
        }
        .banner-right img {
            width: 100%;
            height: 150px;
            object-fit: cover;
            margin-bottom: 10px;
            border-radius: 5px;
        }
        .section-title {
            color: #77A8A8;
            font-size: 28px;
            margin-bottom: 20px;
        }
        .load-more {
            text-align: center;
            margin-top: 20px;
        }
        .load-more button {
            padding: 10px 20px;
            background: #007bff;
            color: #fff;
            border: none;
            border-radius: 5px;
            cursor: pointer;
        }
        .load-more button:hover {
            background: #0056b3;
        }
        .load-more button:disabled {
            background: #ccc;
            cursor: not-allowed;
        }
        .loading {
            text-align: center;
            padding: 20px;
            color: #666;
        }
        .error {
            text-align: center;
            padding: 20px;
            color: #d9534f;
            background-color: #f2dede;
            border: 1px solid #ebccd1;
            border-radius: 5px;
            margin-bottom: 20px;
        }
    </style>
</head>

<body>
    <nav class="navbar navbar-expand-lg bg-black border-bot fixed-top">
        <div class="container">
            <a class="navbar-brand" href="index.html">
                <img src="images/3K%20IMG/shop.png" alt="" />
            </a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarSupportedContent">
                <span class="navbar-toggler-icon bg-white"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarSupportedContent">
                <ul class="navbar-nav mx-auto mb-2 mb-lg-0">
                    <li class="nav-item">
                        <a class="nav-link" href="Product.html">SẢN PHẨM</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link active" href="news.html">TIN TỨC</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="#">KHUYẾN MÃI</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="Contact.html">LIÊN HỆ</a>
                    </li>
                </ul>
                <div class="d-flex">
                    <a href="#" class="nav-link text-white me-3" id="searchIcon"><i class="fas fa-search"></i></a>
                    <div class="dropdown me-3">
                        <a href="#" class="nav-link text-white dropdown-toggle" id="userIcon" data-bs-toggle="dropdown">
                            <i class="fas fa-user"></i>
                        </a>
                        <ul class="dropdown-menu dropdown-menu-end">
                            <li><a class="dropdown-item" href="login.html" id="loginLink">Đăng nhập</a></li>
                            <li><a class="dropdown-item" href="signup.html" id="signupLink">Đăng ký</a></li>
                            <li><a class="dropdown-item" href="profile.html" id="ProfileLink">Trang cá nhân</a></li>
                            <li><a class="dropdown-item" href="#" id="logoutBtn" style="display: none;">Đăng xuất</a></li>
                        </ul>
                    </div>
                    <a href="#" class="nav-link text-white" id="cartIcon"><i class="fas fa-shopping-cart"></i></a>
                </div>
            </div>
        </div>
    </nav>

    <main>
        <section id="product-banner">
            <img src="images/3K IMG/Banner pic3.jpg" alt="Product Banner" class="non-moving-img" />
        </section>
        
        <section class="news-section">
            <div class="container">
                <div class="row">
                    <div class="col-md-8">
                        <div class="news-container">
                            <h2 class="section-title">TẤT CẢ BÀI VIẾT</h2>
                            <div id="news-list">
                                <div class="loading">Đang tải bài viết...</div>
                            </div>
                            <div class="load-more">
                                <button id="load-more-btn">Xem thêm</button>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="banner-right">
                            <h3 class="section-title">BANNER</h3>
                            <div id="banner-list">
                                <!-- Dynamic banners will be inserted here -->
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </section>
    </main>

    <footer class="bg-black text-white">
        <div class="container">
            <div class="row">
                <div class="col-lg-3 p-3">
                    <a href="#"><img src="images/3K%20IMG/3kshop.png" alt="" /></a>
                    <p class="pt-3">
                        West City, 28/43 Siêu đô thị, Trái Đất <br />Khu phố Suginami, Tokyo, Thế kỷ 22 <br />Đảo Cacao, Biển Tân Thế Giới
                    </p>
                    <p class="pt-3">
                        <i class="fas fa-phone"></i> 0123456789
                    </p>
                </div>
                <div class="col-lg-3 p-3">
                    <p>Về chúng tôi</p>
                    <ul class="nav flex-column">
                        <li class="nav-item">
                            <a href="Contact.html" class="nav-link">Giới Thiệu Về MUSIC LOVER</a>
                        </li>
                        <li class="nav-item">
                            <a href="index.html" class="nav-link">Trang Chủ</a>
                        </li>
                        <li class="nav-item">
                            <a href="Product.html" class="nav-link">Sản Phẩm</a>
                        </li>
                    </ul>
                </div>
                <div class="col-lg-3 p-3">
                    <p>Địa chỉ chi tiết</p>
                    <ul class="nav flex-column">
                        <li class="nav-item">
                            <a href="#" class="nav-link">Tầng cao nhất, Tháp Korin, Cõi Trời</a>
                        </li>
                        <li class="nav-item">
                            <a href="#" class="nav-link">Động Going Merry, Cảng Biển Foosha</a>
                        </li>
                    </ul>
                </div>
            </div>
        </div>
    </footer>

    <script src="js/jquery-3.6.0.min.js"></script>
    <script src="js/bootstrap.bundle.min.js"></script>
    <script src="js/owl.carousel.js"></script>
    <script src="js/carousel-control.js"></script>
    <script src="js/product-links.js"></script>
    <script src="js/product-details.js"></script>
    <script src="js/auth.js"></script>
    <script src="js/search.js"></script>
    
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            let offset = 0;
            const limit = 5;
            const newsList = document.getElementById('news-list');
            const bannerList = document.getElementById('banner-list');
            const loadMoreBtn = document.getElementById('load-more-btn');
            let loading = false;

            function calculateDaysAgo(datePosted) {
                const now = new Date();
                const postedDate = new Date(datePosted);
                const diffTime = Math.abs(now - postedDate);
                const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
                return diffDays;
            }

            function truncateContent(content, maxLength = 150) {
                if (content.length <= maxLength) return content;
                return content.substring(0, maxLength) + '...';
            }

            function loadNews() {
                if (loading) return;
                loading = true;
                loadMoreBtn.disabled = true;
                loadMoreBtn.textContent = 'Đang tải...';

                fetch(`http://localhost:3000/api/news/latest?offset=${offset}&limit=${limit}`)
                    .then(response => {
                        if (!response.ok) {
                            throw new Error(`HTTP error! status: ${response.status}`);
                        }
                        return response.json();
                    })
                    .then(news => {
                        // Xóa loading message khi tải lần đầu
                        if (offset === 0) {
                            newsList.innerHTML = '';
                        }

                        if (news.length === 0) {
                            if (offset === 0) {
                                newsList.innerHTML = '<div class="error">Không có bài viết nào</div>';
                            }
                            loadMoreBtn.textContent = 'Hết bài viết';
                            loadMoreBtn.disabled = true;
                            return;
                        }

                        news.forEach(item => {
                            const daysAgo = calculateDaysAgo(item.date_posted);
                            const newsItem = document.createElement('div');
                            newsItem.className = 'news-item';
                            
                            // Xử lý content để loại bỏ HTML tags và truncate
                            const tempDiv = document.createElement('div');
                            tempDiv.innerHTML = item.content;
                            const textContent = tempDiv.textContent || tempDiv.innerText || '';
                            const truncatedContent = truncateContent(textContent);

                            newsItem.innerHTML = `
                                <img src="${item.image || 'images/3K IMG/News/placeholder.jpg'}" 
                                     alt="${item.title}" 
                                     onerror="this.onerror=null; this.src='images/3K IMG/News/placeholder.jpg';" />
                                <div class="content">
                                    <p class="news-id">Bài viết ID: ${item.id}</p>
                                    <h3><a href="news-detail.html?id=${item.id}">${item.title}</a></h3>
                                    <p class="date">${daysAgo} ngày trước</p>
                                    <a href="news-detail.html?id=${item.id}" class="btn btn-primary">Đọc thêm →</a>
                                </div>
                            `;
                            newsList.appendChild(newsItem);
                        });

                        // Render banner_right images
                        const banners = news.filter(item => item.banner_right).map(item => item.banner_right);
                        if (offset === 0) {
                            bannerList.innerHTML = '';
                        }
                        if (banners.length > 0) {
                            banners.forEach(url => {
                                const bannerImg = document.createElement('img');
                                bannerImg.src = url;
                                bannerImg.alt = 'Banner';
                                bannerImg.onerror = function() {
                                    this.onerror = null;
                                    this.src = 'images/3K IMG/News/placeholder.jpg';
                                };
                                bannerList.appendChild(bannerImg);
                            });
                        } else if (offset === 0) {
                            bannerList.innerHTML = '<p>Không có banner</p>';
                        }

                        offset += limit;
                        loadMoreBtn.textContent = 'Xem thêm';
                        loadMoreBtn.disabled = false;
                        loading = false;
                    })
                    .catch(error => {
                        console.error('Error loading news:', error);
                        if (offset === 0) {
                            newsList.innerHTML = `
                                <div class="error">
                                    Lỗi tải bài viết: ${error.message}
                                    <br><small>Vui lòng kiểm tra xem server có đang chạy không</small>
                                </div>
                            `;
                        } else {
                            alert('Lỗi tải bài viết: ' + error.message);
                        }
                        loadMoreBtn.textContent = 'Xem thêm';
                        loadMoreBtn.disabled = false;
                        loading = false;
                    });
            }

            // Tải bài viết ban đầu
            loadNews();

            // Xử lý nút "Xem thêm"
            loadMoreBtn.addEventListener('click', loadNews);
        });
    </script>
</body>
</html>