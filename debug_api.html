<!DOCTYPE html>
<html>
<head>
    <title>Debug Admin Orders API</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        .result { background: #f5f5f5; padding: 15px; margin: 10px 0; border-radius: 5px; }
        .error { background: #ffebee; color: #c62828; }
        .success { background: #e8f5e8; color: #2e7d32; }
        pre { white-space: pre-wrap; word-wrap: break-word; }
        button { padding: 10px 20px; margin: 5px; cursor: pointer; }
    </style>
</head>
<body>
    <h1>Debug Admin Orders API</h1>
    
    <div>
        <button onclick="testOrdersAPI()">Test Orders API</button>
        <button onclick="testSingleOrder()">Test Single Order</button>
        <button onclick="checkToken()">Check Token</button>
    </div>
    
    <div id="results"></div>

    <script>
        function addResult(title, content, type = 'result') {
            const div = document.createElement('div');
            div.className = `result ${type}`;
            div.innerHTML = `<h3>${title}</h3><pre>${content}</pre>`;
            document.getElementById('results').appendChild(div);
        }

        function checkToken() {
            const token = localStorage.getItem('token');
            if (token) {
                addResult('Token Status', `Token exists: ${token.substring(0, 20)}...`, 'success');
            } else {
                addResult('Token Status', 'No token found! Please login first.', 'error');
            }
        }

        async function testOrdersAPI() {
            try {
                const token = localStorage.getItem('token');
                if (!token) {
                    addResult('Error', 'No token found. Please login first.', 'error');
                    return;
                }

                addResult('Request', 'Calling GET /api/admin/orders...');

                const response = await fetch('http://localhost:3000/api/admin/orders', {
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    }
                });

                addResult('Response Status', `${response.status} ${response.statusText}`);

                const data = await response.json();
                addResult('Full Response', JSON.stringify(data, null, 2));

                if (data.orders && data.orders.length > 0) {
                    const firstOrder = data.orders[0];
                    addResult('First Order Analysis', `
Order ID: ${firstOrder.id}
Order Code: ${firstOrder.order_code}
User ID: ${firstOrder.user_id}
Address ID: ${firstOrder.address_id || 'NULL'}

=== SHIPPING INFO (OLD) ===
shipping_name: ${firstOrder.shipping_name || 'NULL'}
shipping_phone: ${firstOrder.shipping_phone || 'NULL'}
shipping_address: ${firstOrder.shipping_address || 'NULL'}

=== ADDRESS INFO (NEW) ===
address_name: ${firstOrder.address_name || 'NULL'}
address_phone: ${firstOrder.address_phone || 'NULL'}
address_detail: ${firstOrder.address_detail || 'NULL'}
ward_name: ${firstOrder.ward_name || 'NULL'}
district_name: ${firstOrder.district_name || 'NULL'}
province_name: ${firstOrder.province_name || 'NULL'}

=== USER INFO ===
username: ${firstOrder.username || 'NULL'}
email: ${firstOrder.email || 'NULL'}
user_fullname: ${firstOrder.user_fullname || 'NULL'}
user_phone: ${firstOrder.user_phone || 'NULL'}
                    `);

                    if (firstOrder.address_id) {
                        addResult('Analysis', 'This order has address_id - should show user_addresses data', 'success');
                    } else {
                        addResult('Analysis', 'This order has NO address_id - will show shipping_* data (fallback)', 'error');
                    }
                } else {
                    addResult('No Orders', 'No orders found in response');
                }

            } catch (error) {
                addResult('Error', error.message, 'error');
            }
        }

        async function testSingleOrder() {
            try {
                const token = localStorage.getItem('token');
                if (!token) {
                    addResult('Error', 'No token found. Please login first.', 'error');
                    return;
                }

                // First get orders list to get an order ID
                const listResponse = await fetch('http://localhost:3000/api/admin/orders', {
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    }
                });

                const listData = await listResponse.json();
                if (!listData.orders || listData.orders.length === 0) {
                    addResult('Error', 'No orders found to test single order API', 'error');
                    return;
                }

                const orderId = listData.orders[0].id;
                addResult('Testing Single Order', `Testing order ID: ${orderId}`);

                const response = await fetch(`http://localhost:3000/api/admin/orders/${orderId}`, {
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    }
                });

                const data = await response.json();
                addResult('Single Order Response', JSON.stringify(data, null, 2));

            } catch (error) {
                addResult('Error', error.message, 'error');
            }
        }

        // Auto check token on load
        window.onload = function() {
            checkToken();
        };
    </script>
</body>
</html>
